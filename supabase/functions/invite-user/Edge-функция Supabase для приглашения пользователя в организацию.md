Edge-функция Supabase для приглашения пользователя в организацию

Что в текущем файле требует внимания
CORS заголовки
У вас нет Access-Control-Allow-Methods. При preflight браузер/некоторые клиентские среды могут резать запросы. Добавьте POST, OPTIONS.

Проверка ключа
Вы сверяете заголовок API‑ключа с FUNCTION_API_KEY — это ок. Но лучше использовать единый заголовок, например x-api-key, и всегда отвечать 401/403 без лишних деталей.

Валидация входа
Вы требуете role как обязательный параметр. Это не всегда нужно: по умолчанию можно принимать member, а admin — опционально.

Поиск пользователя
Сейчас вы зовёте auth.admin.inviteUserByEmail, а при ошибке — auth.admin.listUsers({ email }). В supabase-js v2 есть прямой метод auth.admin.getUserByEmail(email). Он надёжнее и проще. listUsers обычно без фильтра по email и возвращает страницы.

Текст ошибок и локализация
Часть сообщений об ошибках на английском/с placeholders; приведите к понятным русским и не раскрывайте внутренние детали вовне.

Организация «inactive»
В вашей схеме таблица organizations содержит только id, name, external_id. Поля «активности» нет. Формулировка not found or inactive может путать — либо добавьте столбец is_active, либо меняйте текст ответа.

Upsert участника
При upsert в organization_members лучше явно указать onConflict: 'user_id,organization_id', чтобы чётко задействовать уникальный ключ. Это защитит от дублей и гонок.

Бизнес‑логика в БД
У вас уже есть SQL‑RPC invite_user_to_organization(p_organization_id, p_invitee_email). Лучше вызывать его, а не руками править organization_members. Это держит правила в одной точке (миграции/БД).

Готовая версия с вызовом SQL‑RPC
Я подготовила улучшенный файл, который:

корректно обрабатывает CORS и preflight;

валидирует вход и ключ доступа;

ищет пользователя через getUserByEmail, а если нет — шлёт приглашение inviteUserByEmail;

вызывает вашу SQL‑функцию invite_user_to_organization (приглашает как member);

при role: "admin" пытается повысить роль отдельным UPDATE.