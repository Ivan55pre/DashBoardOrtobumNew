Что теперь делает функция
Находит или создаёт организацию по organization_name.

Вызывает вашу SQL‑функцию public.invite_user_to_organization(p_organization_id uuid, p_invitee_email text) — именно она добавляет пользователя в таблицу organization_members как member.

Если в запросе передать role: "admin", после приглашения пытается повысить роль до admin. (RPC добавляет только member — это осознанно. Повышение делаю отдельным шагом.)

Почему так лучше
Вся доменная логика приглашения и поиска пользователя по email — в БД (одна точка правды).

Edge‑функция остаётся тонкой обвязкой: валидация, CORS, вызов RPC, формат ответа.

При будущих изменениях правил достаточно обновить RPC‑функцию в миграциях.



Как дергать из n8n / Telegram бота
POST на ваш Edge endpoint с телом:

json

{
  "organization_name": "FRESHCAFE",
  "user_email": "user@example.com",
  "role": "admin"
}
role опционален. Если не указывать — будет member.

Важные пометки
RPC invite_user_to_organization в ваших миграциях имеет SECURITY INVOKER и сам ищет пользователя по auth.users. Мы вызываем её сервисным ключом — RLS нас не ограничит.

Если хотите полностью убрать апдейт роли из функции — добавьте отдельный SQL‑RPC вроде set_member_role(p_organization_id uuid, p_email text, p_role text) и вызывайте его после приглашения.

В коде оставлен «fallback» на случай, если вы захотите централизованный RPC exec_sql для универсальных апдейтов (у вас его нет — поэтому блок отмечен как запасной; по умолчанию всё и так сработает через обычный update).