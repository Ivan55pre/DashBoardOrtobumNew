<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Выбор организации</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; background: #f8f8fa; margin:0; padding:2rem; }
    .container { background:#fff; border-radius:16px; max-width:350px; margin:2rem auto; box-shadow:0 4px 18px 0 #0001; padding:2rem; }
    label { display:block; margin-bottom:0.7rem; font-size:1.1rem; }
    select { width:100%; font-size:1rem; padding:0.5rem; margin-bottom:1.2rem; border-radius:7px; border:1px solid #aaa;}
    button { width:100%; font-size:1.1rem; padding:0.7rem; border-radius:8px; border:none; background:#0088cc; color:#fff; font-weight:600; cursor:pointer;}
    button:active { background:#005c8c; }
  </style>
</head>
<body>
  <div class="container">
    <form id="orgForm">
      <label for="orgSelect">Выберите организацию</label>
      <select id="orgSelect" name="название_организации" required>
        <!-- Варианты подставляются динамически -->
      </select>
      <button type="submit">Подтвердить</button>
    </form>
  </div>
  <script>
    // Получаем список организаций из window.INIT_DATA или из URL-параметра orgs
    let orgs = window.INIT_DATA;
    if (!orgs) {
      const params = new URLSearchParams(window.location.search);
      if(params.has('orgs')) {
        orgs = decodeURIComponent(params.get('orgs')).split(',');
      }
    }
    if (!orgs || !Array.isArray(orgs)) orgs = ["Организация 1", "Организация 2"];

    // Заполняем select
    const sel = document.getElementById('orgSelect');
    orgs.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });

    // Получаем user_id из URL (если нужен)
    const params = new URLSearchParams(window.location.search);
    const userId = params.get('user_id');

    document.getElementById('orgForm').addEventListener('submit', function(e){
        e.preventDefault();
        const val = sel.value;
        const userId = params.get('user_id');
        const button = e.target.querySelector('button');

        // Даем пользователю обратную связь и предотвращаем повторные нажатия
        button.disabled = true;
        button.textContent = 'Отправка...';

        // Отправка в n8n
        fetch('https://n8n.preivan.ru/webhook/VoprosOrganization', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: userId,
                val: val
            })
        })
        .then(response => {
            // Нам не важно тело ответа, главное, что сервер ответил успехом (статус 2xx)
            if (!response.ok) {
                console.error('Server responded with an error:', response.status, response.statusText);
            }
        })
        .catch(error => {
            // Логируем сетевые ошибки (например, CORS или нет сети)
            console.error('Fetch error:', error);
        })
        .finally(() => {
            // Этот блок выполнится всегда: и после успеха, и после ошибки.
            // Это самое надежное место для вызова close().
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.close) {
                Telegram.WebApp.close();
            }
        });
    });

    // Если пользователь просто закрыл окно — обычно этого достаточно:
    window.onbeforeunload = function() {
      // Просто placeholder. Если хотите — отправляйте событие в n8n здесь.
    };
  </script>
</body>
</html>
