Как система строит иерархию: Для загрузки данных в систему используется специальная SQL-функция upsert_cash_bank_report. Эта функция отвечает не только за вставку данных, но и за создание иерархических связей, проставляя правильный parent_id для каждой дочерней записи.

В чем заключается несоответствие: Эта функция ожидает на вход данные в формате JSON и имеет два ключевых предположения:

Для построения иерархии у каждой дочерней записи должно быть поле parent_account_name, содержащее имя родительской записи.
(Это корень проблемы) Функция предполагает, что поле account_name у каждой записи, которая может быть родителем, уникально. Она использует это имя как ключ для поиска родителя.
Почему ваши данные не подходят: В вашем файле cash_bank_report_items_rows.csv это условие не выполняется. Например, у вас есть родительская запись level: 2 с account_name: 'Сбербанк' и несколько дочерних записей level: 3, у которых account_name тоже 'Сбербанк'. Когда функция загрузки пытается найти родителя для дочерней записи, она не может однозначно его определить, так как несколько записей имеют одинаковое имя. В результате связи не создаются, и все записи в отчете отображаются на одном уровне, без вложенности.

Рекомендуемый формат данных для загрузки
Чтобы обойти это ограничение текущей системы, вам необходимо подготовить данные в формате JSON, где каждая запись будет иметь уникальное имя в поле account_name. Дочерние записи должны будут ссылаться на уникальное имя родителя через поле parent_account_name.

Вот пример, как можно преобразовать ваши данные по "Сбербанку" в правильный JSON-формат для загрузки.

Исходные данные из CSV:

Родитель: account_name: Сбербанк, level: 2, balance_current: 13321.95
Ребенок 1: account_name: Сбербанк, level: 3, subconto: 3.10.1..., expense_amount: 8.00
Ребенок 2: account_name: Сбербанк, level: 3, subconto: 2.1.1..., expense_amount: 354060.00

Ключевые моменты в этом формате:

Уникальность account_name: Обратите внимание, что у дочерних записей account_name изменено на уникальное (например, "Сбербанк - РКО"). Это позволяет системе однозначно идентифицировать каждую запись.
Ссылка parent_account_name: У дочерних записей поле parent_account_name теперь четко указывает на уникальное имя родителя — "Сбербанк".
Формат JSON: Данные должны быть представлены в виде массива объектов JSON, а не в CSV.

